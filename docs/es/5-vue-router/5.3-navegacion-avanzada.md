# 5.3 Navegaci√≥n Avanzada con Vue Router en Composition API

## üéØ Introducci√≥n

En esta gu√≠a aprenderemos a manejar la navegaci√≥n avanzada en Vue 3 usando Vue Router con la Composition API. Veremos c√≥mo proteger rutas, cargar componentes de forma perezosa y mejorar la experiencia de usuario con transiciones.

## üîí Guards de Navegaci√≥n

Los guards son funciones que nos permiten controlar la navegaci√≥n entre rutas. Hay tres tipos principales:

### 1. Guard Global

Se ejecuta antes de cada cambio de ruta. Ideal para verificar autenticaci√≥n global. Aqu√≠ tienes un ejemplo completo de c√≥mo quedar√≠a el archivo `src/router/index.js`:

```javascript
// src/router/index.js
import { createRouter, createWebHistory } from 'vue-router';
import HomeView from '../views/HomeView.vue';

// Definici√≥n de rutas
const routes = [
  {
    path: '/',
    name: 'home',
    component: HomeView
  },
  {
    path: '/login',
    name: 'login',
    component: () => import('../views/LoginView.vue'),
    meta: { 
      guestOnly: true // Solo usuarios no autenticados
    }
  },
  {
    path: '/dashboard',
    name: 'dashboard',
    component: () => import('../views/DashboardView.vue'),
    meta: { 
      requiresAuth: true // Requiere autenticaci√≥n
    }
  },
  {
    path: '/perfil',
    name: 'perfil',
    component: () => import('../views/PerfilView.vue'),
    meta: { 
      requiresAuth: true
    }
  },
  {
    path: '/:pathMatch(.*)*',
    name: 'not-found',
    component: () => import('../views/NotFoundView.vue')
  }
];

// Creaci√≥n del router
const router = createRouter({
  history: createWebHistory(import.meta.env.BASE_URL),
  routes
});

// Guard de navegaci√≥n global
router.beforeEach((to, from, next) => {
  // Verificar si la ruta requiere autenticaci√≥n
  if (to.meta.requiresAuth && !localStorage.getItem('token')) {
    // Redirigir a login con la ruta de retorno
    next({ 
      name: 'login', 
      query: { redirect: to.fullPath } 
    });
  } 
  // Si la ruta es solo para invitados y el usuario est√° autenticado
  else if (to.meta.guestOnly && localStorage.getItem('token')) {
    next({ name: 'dashboard' });
  }
  // En cualquier otro caso, continuar con la navegaci√≥n
  else {
    next();
  }
});

// Manejo de errores global
router.onError((error) => {
  console.error('Error de enrutamiento:', error);
  // Podr√≠as redirigir a una p√°gina de error aqu√≠ si lo deseas
});

export default router;
```

### 2. Guard de Ruta

Se aplica a rutas espec√≠ficas.

```javascript
const routes = [
  {
    path: '/perfil',
    name: 'perfil',
    component: () => import('../views/PerfilView.vue'),
    meta: { requiresAuth: true },
    // Guard espec√≠fico de esta ruta
    beforeEnter: (to, from, next) => {
      const userRole = localStorage.getItem('userRole');
      if (userRole !== 'admin') {
        next({ name: 'acceso-denegado' });
      } else {
        next();
      }
    }
  }
];
```

### 3. Guards en Componentes (Composition API)

```vue
<!-- PerfilView.vue -->
<template>
  <div>
    <h1>Mi Perfil</h1>
    <!-- Contenido del perfil -->
  </div>
</template>

<script setup>
import { onBeforeRouteLeave, onBeforeRouteUpdate } from 'vue-router';
import { ref } from 'vue';

const cambiosSinGuardar = ref(false);

// Se ejecuta cuando el componente est√° a punto de ser abandonado
onBeforeRouteLeave((to, from, next) => {
  if (cambiosSinGuardar.value) {
    if (confirm('¬øTienes cambios sin guardar. ¬øSeguro que quieres salir?')) {
      next();
    } else {
      next(false); // Cancela la navegaci√≥n
    }
  } else {
    next();
  }
});

// Se ejecuta cuando cambian los par√°metros de la ruta
onBeforeRouteUpdate((to, from) => {
  // Por ejemplo, si la ruta es /usuario/1 y cambia a /usuario/2
  console.log('El ID del usuario cambi√≥ de', from.params.id, 'a', to.params.id);
});
</script>
```

## ‚ö° Carga Perezosa (Lazy Loading)

Mejora el rendimiento cargando los componentes solo cuando se necesitan:

```javascript
const routes = [
  {
    path: '/',
    name: 'inicio',
    component: () => import('../views/InicioView.vue')
  },
  {
    path: '/productos',
    name: 'productos',
    // Carga perezosa con agrupaci√≥n
    component: () => import(/* webpackChunkName: "catalogo" */ '../views/ProductosView.vue')
  },
  {
    path: '/contacto',
    name: 'contacto',
    component: () => import(/* webpackChunkName: "info" */ '../views/ContactoView.vue')
  }
];
```

## üñ±Ô∏è Comportamiento del Scroll

Controla la posici√≥n del scroll al navegar entre rutas:

```javascript
const router = createRouter({
  history: createWebHistory(),
  routes,
  scrollBehavior(to, from, savedPosition) {
    // Si hay un hash (ej: #seccion), hacer scroll a ese elemento
    if (to.hash) {
      return {
        el: to.hash,
        behavior: 'smooth',
      };
    }
    // Si es una navegaci√≥n hacia atr√°s/adelante, restaurar posici√≥n
    if (savedPosition) {
      return savedPosition;
    }
    // Por defecto, ir al inicio de la p√°gina
    return { top: 0 };
  },
});
```

## ‚ú® Transiciones entre Rutas

A√±ade animaciones suaves al cambiar de ruta:

```vue
<template>
  <!-- Transici√≥n para todas las vistas del router -->
  <router-view v-slot="{ Component }">
    <transition name="fade" mode="out-in">
      <component :is="Component" />
    </transition>
  </router-view>
</template>

<style>
/* Animaci√≥n de fundido */
.fade-enter-active,
.fade-leave-active {
  transition: opacity 0.3s ease;
}

.fade-enter-from,
.fade-leave-to {
  opacity: 0;
}

/* Animaci√≥n de deslizamiento */
.slide-enter-active {
  transition: all 0.3s ease-out;
}

.slide-leave-active {
  transition: all 0.3s ease-in;
}

.slide-enter-from {
  transform: translateX(20px);
  opacity: 0;
}

.slide-leave-to {
  transform: translateX(-20px);
  opacity: 0;
}
</style>
```

## üìå Ejemplo Pr√°ctico: Protecci√≥n de Ruta

Vamos a implementar un sistema de autenticaci√≥n simple:

1. **Crea un store de autenticaci√≥n** (usando Pinia):

```javascript
// stores/auth.js
import { defineStore } from 'pinia';

export const useAuthStore = defineStore('auth', {
  state: () => ({
    user: null,
    token: localStorage.getItem('token') || null,
  }),
  getters: {
    isAuthenticated: (state) => !!state.token,
  },
  actions: {
    login(credentials) {
      // L√≥gica de autenticaci√≥n
      this.token = 'token_simulado';
      localStorage.setItem('token', this.token);
    },
    logout() {
      this.token = null;
      localStorage.removeItem('token');
    },
  },
});
```

2. **Configura las rutas protegidas**:

```javascript
const routes = [
  {
    path: '/',
    name: 'inicio',
    component: () => import('../views/InicioView.vue')
  },
  {
    path: '/dashboard',
    name: 'dashboard',
    component: () => import('../views/DashboardView.vue'),
    meta: { requiresAuth: true } // Ruta protegida
  },
  {
    path: '/login',
    name: 'login',
    component: () => import('../views/LoginView.vue'),
    meta: { guestOnly: true } // Solo para usuarios no autenticados
  }
];
```

3. **Implementa el guard de navegaci√≥n**:

```javascript
router.beforeEach((to, from, next) => {
  const authStore = useAuthStore();
  
  // Si la ruta requiere autenticaci√≥n y el usuario no est√° autenticado
  if (to.meta.requiresAuth && !authStore.isAuthenticated) {
    next({ name: 'login', query: { redirect: to.fullPath } });
  } 
  // Si la ruta es solo para invitados y el usuario est√° autenticado
  else if (to.meta.guestOnly && authStore.isAuthenticated) {
    next({ name: 'dashboard' });
  } 
  // En cualquier otro caso, continuar
  else {
    next();
  }
});
```

## üìö Recursos Adicionales

- [Documentaci√≥n oficial de Vue Router](https://router.vuejs.org/)
- [Gu√≠a de migraci√≥n a Vue Router 4](https://router.vuejs.org/guide/migration/)
- [Patrones de navegaci√≥n avanzados](https://router.vuejs.org/guide/advanced/navigation-guards.html)

## üöÄ Siguientes Pasos

Ahora que has aprendido sobre navegaci√≥n avanzada, te animo a:

1. Implementar un sistema de roles y permisos
2. Crear rutas anidadas para interfaces complejas
3. Experimentar con diferentes tipos de transiciones
4. Probar el lazy loading con diferentes estrategias de agrupaci√≥n

¬°Practica estos conceptos en el [ejercicio pr√°ctico](5.4-ejercicio-practico.md) para afianzar tus conocimientos!
