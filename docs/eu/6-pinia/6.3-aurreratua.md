# 6.3 Pinia-ko Gai Aurreratuak

## Egoeraren Persistentzioa

Orria birkargatzean egoera mantentzeko, erabili `pinia-plugin-persistedstate`:

```bash
npm install pinia-plugin-persistedstate
```

Aplicazioan konfigurazioa (ohikoena `main.ts` edo `main.js`-en):

```typescript
import { createApp } from 'vue'
import { createPinia } from 'pinia'
import piniaPluginPersistedstate from 'pinia-plugin-persistedstate'
import App from './App.vue'

const app = createApp(App)
const pinia = createPinia()

// Persistentzia plugina erabili
pinia.use(piniaPluginPersistedstate)

app.use(pinia)
app.mount('#app')
```

Ondoren, Composition API bidezko dendaren adibidea:

```typescript
// stores/user.ts
import { defineStore } from 'pinia'

export const useUserStore = defineStore('user', () => {
  // Egoera
  const user = ref<{id: string, name: string, email: string} | null>(null)
  const preferences = ref({
    theme: 'light',
    notifications: true,
    language: 'eu',
  })

  // Ekintzak
  function login(userData: {id: string, name: string, email: string}) {
    user.value = userData
  }

  function updatePreferences(newPreferences: Partial<typeof preferences.value>) {
    preferences.value = { ...preferences.value, ...newPreferences }
  }

  return {
    // Egoera
    user,
    preferences,

    // Ekintzak
    login,
    updatePreferences,
  }
}, {
  // Persistentziaren konfigurazioa (aukerakoa)
  persist: {
    paths: ['user'],
    storage: localStorage,
  }
})
```

## Moduluak eta Habiaratutako Dendak

Zure logika hainbat dendatan antola dezakezu eta elkarrekin erabili:

```typescript
// stores/user.ts
export const useUserStore = defineStore('user', () => {
  // Egoera
  const name = ref('Erabiltzailea')
  const isAuthenticated = ref(false)

  // Ekintzak
  function login() {
    isAuthenticated.value = true
  }

  return {
    name,
    isAuthenticated,
    login
  }
})

// stores/cart.ts
export const useCartStore = defineStore('cart', () => {
  // Egoera
  const items = ref<Array<{id: number, name: string, price: number}>>([])

  // Getterrak
  const totalItems = computed(() => items.value.length)
  const totalPrice = computed(() =>
    items.value.reduce((total, item) => total + item.price, 0)
  )

  // Ekintzak
  function addItem(item: {id: number, name: string, price: number}) {
    items.value.push(item)
  }

  function removeItem(itemId: number) {
    const index = items.value.findIndex(item => item.id === itemId)
    if (index !== -1) items.value.splice(index, 1)
  }

  return {
    items,
    totalItems,
    totalPrice,
    addItem,
    removeItem
  }
})

// Osagai baten adibidea
<script setup lang="ts">
import { useUserStore } from '@/stores/user'
import { useCartStore } from '@/stores/cart'
import { useRouter } from 'vue-router'

const user = useUserStore()
const cart = useCartStore()
const router = useRouter()

const checkout = () => {
  if (user.isAuthenticated) {
    // Erosketa prozesatu
    console.log('Erosketa prozesatzen...', cart.items)
  } else {
    // Login-era birbideratu
    router.push('/login')
  }
}
</script>

<template>
  <div>
    <h1>Erosketa Saskia</h1>
    <p v-if="!user.isAuthenticated">
      Mesedez, <button @click="user.login">hasi saioa</button> jarraitzeko.
    </p>
    <div v-else>
      <p>Ongi etorri, {{ user.name }}</p>
      <div v-if="cart.totalItems > 0">
        <p>Produktu kopurua: {{ cart.totalItems }}</p>
        <p>Guztira: â‚¬{{ cart.totalPrice.toFixed(2) }}</p>
        <button @click="checkout">Erosi</button>
      </div>
      <p v-else>Zure saskia hutsik dago</p>
    </div>
  </div>
</template>
```

## Pinia-rekin Testing-a

Zure dendak probatzeko, erabili `@vue/test-utils` eta `@pinia/testing`. Hona hemen konfigurazioa eta adibideak Composition API-rekin:

```bash
npm install -D @vue/test-utils @vue/vue3-jest @testing-library/vue @testing-library/jest-dom
```

### Oinarrizko konfigurazioa

`jest.config.js` adibidea:

```javascript
module.exports = {
  testEnvironment: 'jsdom',
  moduleFileExtensions: ['js', 'ts', 'json', 'vue'],
  transform: {
    '^.+\\.tsx?$': 'ts-jest',
    '^.+\\.vue$': '@vue/vue3-jest',
    '^.+\\.js$': 'babel-jest',
  },
  moduleNameMapper: {
    '^@/(.*)$': '<rootDir>/src/$1',
  },
  testMatch: ['**/__tests__/**/*.spec.[jt]s?(x)'],
}
```

### Denda baten proba adibidea

```typescript
// __tests__/stores/counter.spec.ts
import { setActivePinia, createPinia } from 'pinia'
import { useCounterStore } from '@/stores/counter'

describe('Counter Store', () => {
  beforeEach(() => {
    setActivePinia(createPinia())
  })

  it('hasieratzen da 0 balioarekin', () => {
    const counter = useCounterStore()
    expect(counter.count).toBe(0)
  })

  it('handitzen du balioa', () => {
    const counter = useCounterStore()
    counter.increment()
    expect(counter.count).toBe(1)
  })

  it('berrezartzen du balioa', () => {
    const counter = useCounterStore()
    counter.increment()
    counter.increment()
    counter.$reset()
    expect(counter.count).toBe(0)
  })
})
```

### Pinia darabilen osagai baten proba

```typescript
// __tests__/components/Counter.spec.ts
import { mount } from '@vue/test-utils'
import { createTestingPinia } from '@pinia/testing'
import Counter from '@/components/Counter.vue'

describe('Counter.vue', () => {
  it('balioa erakusten du eta klikari erantzuten dio', async () => {
    const wrapper = mount(Counter, {
      global: {
        plugins: [
          createTestingPinia({
            createSpy: vi.fn,
            initialState: {
              counter: { count: 5 }
            }
          })
        ]
      }
    })

    expect(wrapper.find('p').text()).toContain('5')

    await wrapper.find('button').trigger('click')

    expect(wrapper.find('p').text()).toContain('6')
  })
})
```

### Dendako ekintzak mockeatu

```typescript
// __tests__/components/UserProfile.spec.ts
import { mount } from '@vue/test-utils'
import { createTestingPinia } from '@pinia/testing'
import UserProfile from '@/components/UserProfile.vue'

describe('UserProfile.vue', () => {
  it('fetchUser deitzen du osagaia muntatzean', async () => {
    const mockUser = { id: 1, name: 'Proba Erabiltzailea' }

    const wrapper = mount(UserProfile, {
      global: {
        plugins: [
          createTestingPinia({
            createSpy: vi.fn,
            stubActions: false,
            initialState: {
              user: { user: null }
            }
          })
        ]
      }
    })

    const userStore = useUserStore()

    userStore.fetchUser = vi.fn().mockResolvedValue(mockUser)

    await wrapper.vm.$nextTick()

    expect(userStore.fetchUser).toHaveBeenCalledTimes(1)

    await userStore.fetchUser()

    expect(userStore.user).toEqual(mockUser)
  })
})
```
```

## Vue Router-ekin Integrazioa

Pinia Vue Router-ekin batera erabil dezakezu nabigazio babestua egiteko:

```javascript
// router/index.js
import { createRouter, createWebHistory } from 'vue-router'
import { useUserStore } from '@/stores/user'

const routes = [
  {
    path: '/dashboard',
    component: () => import('@/views/Dashboard.vue'),
    meta: { requiresAuth: true }
  },
  // Beste ibilbide batzuk...
]

const router = createRouter({
  history: createWebHistory(),
  routes,
})

router.beforeEach((to, from, next) => {
  const userStore = useUserStore()
  
  if (to.meta.requiresAuth && !userStore.isAuthenticated) {
    next('/login')
  } else {
    next()
  }
})

export default router
```

## TypeScript-ekin Erabilera

Pinia-k lehen mailako euskarria du TypeScript-erako. Hona hemen denda tipatu baten adibidea:

```typescript
// types/user.ts
export interface User {
  id: number
  name: string
  email: string
}

// stores/user.ts (Composition API)
import { defineStore } from 'pinia'
import type { User } from '@/types/user'

export const useUserStore = defineStore('user', () => {
  // Egoera tipatua
  const user = ref<User | null>(null)
  const loading = ref<boolean>(false)
  const error = ref<string | null>(null)

  // Getter tipatua
  const isAdmin: ComputedRef<boolean> = computed(() => {
    // @ts-expect-error role ez dago definituta oinarrizko User interfazean; zabaldu ezazu behar baduzu
    return user.value?.role === 'admin'
  })

  // Ekintza tipatua
  async function fetchUser(userId: number): Promise<void> {
    loading.value = true
    error.value = null
    try {
      const response = await fetch(`/api/users/${userId}`)
      const data: User = await response.json()
      user.value = data
    } catch (err) {
      error.value = err instanceof Error ? err.message : 'Errore ezezaguna'
    } finally {
      loading.value = false
    }
  }

  return {
    user,
    loading,
    error,
    isAdmin,
    fetchUser,
  }
})
```

Kontzeptu aurreratu hauekin, ahalik eta gehien aprobetxa dezakezu Pinia zure Vue 3 aplikazioetan.

## Hurrengo urratsa

Pinia-ko gai aurreratuak ikasi ondoren, hurrengo pausoa da [Proiektuaren Egitura](../7-proiektua/7.1-egitura.md) aztertzea; han ikusiko duzu nola integratu ikasitakoa aplikazio oso batean.
